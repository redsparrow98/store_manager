{% extends "base.html" %}
{% block title %}Inventory{% endblock %}
{% block content %}


<div class="inventory-header">
  <h1 class="title">All Products</h1>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
      {% for category, message in messages %}
      {{ message }}
      {% endfor %}
    {% endif %} {% endwith %}

  <div class="inventory-actions">
    <form class="search-button-form btn btn--search" action="{{ url_for('display_inventory') }}" method="get" role="search" aria-label="Search products">
      <span class="search-icon" aria-hidden="true">
        <img src="{{ url_for('static', filename='images/search.svg') }}" alt="">
        <!-- Christmas search icon -->
        <span class="nav-icon christmas-search-icon" aria-hidden="true"></span>
      </span>
      <input
        type="search"
        name="search_term"
        class="search-input-in-btn"
        placeholder="Search by product ID or brand"
        value="{{ request.args.get('search_term','') }}"
      />
    </form>

    <!-- Filter by category -->

    <a
      id="filterToggle" class="btn btn-discount"
    >
      <img
        src="{{ url_for('static', filename='images/filter.svg') }}"
        alt="filter"
        class="btn-icon"
      />
      <span class="nav-icon christmas-filter-icon" aria-hidden="true"></span>
      <span class="btn-label">Filter</span>
    </a>

    <!-- Add discount -->
    <a
      class="btn btn-discount"
      href="{{ url_for('apply_discount_page') }}"
    >
      <img
        src="{{ url_for('static', filename='images/discount.svg') }}"
        alt="discount"
        class="btn-icon"
      />
      <span class="nav-icon christmas-discount-icon" aria-hidden="true"></span>
      <span class="btn-label">Add discount</span>
    </a>

    <!-- Add product -->
    {% if access_level in ["Manager"] %}
    <a
      class="btn btn-discount"
      href="{{ url_for('add_product_page') }}"
    >
      <img
        src="{{ url_for('static', filename='images/plus.svg') }}"
        alt="add"
        class="btn-icon"
      />
      <!-- Christmas plus icon -->
      <span class="btn-icon christmas-plus-icon" aria-hidden="true"></span>
      <span class="btn-label">Add product</span>
    </a>
    {% endif %}
  </div>
</div>

<div id="filterPanel" hidden>
      <div class="table-wrap">
          <h4>Category</h4>
          <div id="categoryFilters"></div>
      </div>
    </div>

<div class="table-wrap">
  <table class="products-table">
    <thead>
      <tr>
        <th class="col-name">Item name</th>
        <th class="col-id">Product ID</th>
        <th class="col-cat">Category</th>
        <th class="col-price">Price</th>
        <th class="col-discount">Discount</th>
        <th class="col-amount">Amount</th>
        <th class="col-actions">Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be populated by JS -->
    </tbody>
  </table>
</div>


<script>
// Pass url for action buttons
const BASE_URLS = {
    view: "{{ url_for('access_product') }}",
  edit: "{{ url_for('update_product_page')}}",
  delete: "{{ url_for('delete_product_page')}}"
}

// Pass products data to JS
const PRODUCTS = Object.entries({{ products | tojson }}).map(
    ([id, item]) => ({
    id: id,
    name: item.article_name,
    category: item.category,
    price: item.price_SEK || item.price,
    amount: item.stock_amount || item.stock,
    discount: item.discount_percentage || 0
})
);

// Pass access level to JS
const accessLevel = "{{ access_level }}";
</script>

<script>
  // Filter panel toggle
const filterToggle = document.getElementById("filterToggle");
const filterPanel = document.getElementById("filterPanel");
const categoryFiltersEl = document.getElementById("categoryFilters");
const tableBody = document.querySelector("tbody");
filterToggle.addEventListener("click", (e) => {
    e.preventDefault();
  filterPanel.hidden = !filterPanel.hidden;
});

const activeCategories = new Set();
const categories = [...new Set(PRODUCTS.map(p => p.category))];
categories.forEach(category => {
    const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = true;
  activeCategories.add(category);

  checkbox.addEventListener("change", () => {
    checkbox.checked
    ? activeCategories.add(category)
      : activeCategories.delete(category);
      render();
});

  const label = document.createElement("label");
  label.textContent = category;

  categoryFiltersEl.append(checkbox, label, document.createElement("br"));
});

// Render products based on checked filters
function render() {
    tableBody.innerHTML = "";

PRODUCTS
.filter(p => activeCategories.has(p.category))
  .forEach(p => {

    // Action buttons
    const viewBtn = `
    <a class="icon-btn" href="${BASE_URLS.view}?search_term=${p.id}" title="View">
      <img src="{{ url_for('static', filename='images/eye.svg') }}" alt="View">
        </a>`;
      const editBtn = `
    <a class="icon-btn" href="${BASE_URLS.edit}?article_id=${p.id}" title="Edit">
      <img src="{{ url_for('static', filename='images/edit.svg') }}" alt="Edit">
        </a>`;
      const deleteBtn = (accessLevel === "Manager") ? `
    <a class="icon-btn" href="${BASE_URLS.delete}?article_id=${p.id}" title="Delete"
      onclick="return confirm('Are you sure you want to delete product ${p.id}?');">
        <img src="{{ url_for('static', filename='images/delete.svg') }}" alt="Delete">
        </a>` : "";
    
      // Render the row
    tableBody.innerHTML += `
    <tr>
      <td class="col-name">${p.name}</td>
        <td class="col-id">${p.id}</td>
        <td class="col-cat">${p.category}</td>
        <td class="col-price">${p.price} kr</td>
        <td class="col-discount">${p.discount}%</td>
        <td class="col-amount">${p.amount} pcs</td>
        <td class="col-actions">
        <div class="col-actions">
          ${viewBtn}
            ${editBtn}
            ${deleteBtn}
            </div>
          </td>
        </tr>`;
    });
}
  render();

</script>

{% endblock %}